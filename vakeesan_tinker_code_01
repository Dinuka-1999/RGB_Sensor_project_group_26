#include <LiquidCrystal.h>
#include <Keypad.h> 
LiquidCrystal lcd(13,12,8,7,A4,A5);
int red_sen = A0;
int green_sen = A1;
int blue_sen = A2;
int ldr_sen = A3;
int red_cal=0;
int green_cal=0;
int blue_cal =0;
int red_out=11;
int green_out=10;
int blue_out = 9;
//added 2nd time
int times=100;
int led_sen[]={red_sen,green_sen,blue_sen};
int cal_arr[3][2];
int iscalibrated=0;
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////initialize keypad/////////////////////////////////////////////////////////////////

const byte numRows= 4; //number of rows on the keypad
const byte numCols= 3; //number of columns on the keypad

//keymap defines the key pressed according to the row and columns just as appears on the keypad
char keymap[numRows][numCols]= 
{
{'1', '2', '3'}, 
{'4', '5', '6'}, 
{'7', '8', '9'},
{'*', '0', '#'}
};

//Code that shows the the keypad connections to the arduino terminals
byte rowPins[numRows] = {6,5,4,3}; //Rows 0 to 3
byte colPins[numCols]= {2,1,0}; //Columns 0 to 3

//initializes an instance of the Keypad class
Keypad myKeypad= Keypad(makeKeymap(keymap), rowPins, colPins, numRows, numCols);


/////////////////////////////calibration function/////////////////////////////////////////////////////////////////
int calibr_fun(){
  lcd.setCursor(0,0);
  lcd.clear();
  lcd.print("1.calibration mode");
  delay(1000);
  
  int tot;
  int val;
  for (int i=0;i<2;i++){
    lcd.print("show the " +String(i+1)+"st card for clibration");
    delay(4000);
    for (int j=0;j<3;j++){
      digitalWrite(led_sen[j],LOW);
      tot=0;
      for (int k=0;k<times;k++){
        val=0;
        val=analogRead(ldr_sen);
        tot=tot+val;
                
        }
      delay(500);
      digitalWrite(led_sen[j],HIGH);
      cal_arr[j][i]=round(tot/times);
      }
    
    }
    lcd.print("calibration process is successfully completed!");
    return 1;
  }

///////////////////////////////////led out function///////////////////////////////////////////////////////////////////
int led_out(int val_1,int val_2,int val_3){
   analogWrite(red_out,val_1);
  analogWrite(green_out,val_2);
  analogWrite(blue_out,val_3);
  delay(4000);
  lcd.print("see RGB LED");
} 


//////////////////////////////////////////sensing////////////////////////////////////////////////////////////////////
void sen_fun(){


  // added 2nd time
  if ( iscalibrated==0){
    lcd.print("you haven't calibrated the device yet");
    iscalibrated=calibr_fun();
    } 
  //off the output leds
  analogWrite(red_out,255);
  analogWrite(green_out,255);
  analogWrite(blue_out,255);


lcd.print("let's sense any colour you want!");
  lcd.clear();
  lcd.setCursor(0,0);
  lcd.print("2.sensing mode");
  lcd.setCursor(0,1);
  lcd.print("1...");
  //for red led on sensor
  digitalWrite(red_sen,LOW);
  int red_val=analogRead(ldr_sen);
  delay(500);
  digitalWrite(red_sen,HIGH);
  
  lcd.setCursor(6,1);
  lcd.print("2...");  
   //for green value on sensor
  digitalWrite(green_sen,LOW);
  int gre_val=analogRead(ldr_sen);
  delay(500);
  digitalWrite(green_sen,HIGH);

  
  lcd.setCursor(11,1);
  lcd.print("3...");
  
  //for blue value on sensor
  digitalWrite(blue_sen,LOW);
  int blu_val=analogRead(ldr_sen);
  delay(500);
  digitalWrite(blue_sen,HIGH);
  
 

  int red_out=(red_val-cal_arr[0][1])/(cal_arr[0][0]-cal_arr[0][1])*255;
  int gre_out=(gre_val-cal_arr[1][1])/(cal_arr[1][0]-cal_arr[1][1])*255;
  int blu_out=(blu_val-cal_arr[2][1])/(cal_arr[2][0]-cal_arr[2][1])*255;
  
  led_out(red_out,green_out,blue_out);
   
  lcd.clear();
  lcd.setCursor(0,0);
  lcd.print("R - ");
  lcd.print(red_out);
  lcd.setCursor(9,0);
  lcd.print("G - ");
  lcd.print(green_out);
  lcd.setCursor(0,1);
  lcd.print("B - ");
  lcd.print(blue_out);
  delay(2000); 
  }
///////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////numerical input/////////////////////////////////////////////////////
int key_numer(){
   int val=0;
  int i=0;
  while (i<3){
    char key= myKeypad.getKey();
    if (key!=NO_KEY){
      
  val=val*10 ;
  (val=(val+key -'0')) ;
  lcd.setCursor(i,1);
  lcd.print(val);
  i=i+1;
  if (i==2){
        delay(1000);}
  }
  }

  return int(val);
}

//------------------------------------------------------------------------------------------------------//
//////////////////////////////////////manual output///////////////////////////////////////////////////////


void manual_out(){
  int red_val=0;
  int green_val=0;
  int blue_val=0;
  lcd.clear();
  lcd.setCursor(0,0);
  lcd.print("3.output mode");
  delay(1000);
  
  lcd.clear();
  lcd.setCursor(0,0);
  lcd.print("type RED value");
  red_val=key_numer();
        
  lcd.clear();
  lcd.setCursor(0,0);
  lcd.print("type GREEN value");
  green_val=key_numer();
  
  lcd.clear();
  lcd.setCursor(0,0);
  lcd.print("type BLUE value");
  blue_val=key_numer();
  
  lcd.clear();
  led_out(red_val,green_val,blue_val);
  }
//--------------------------------------------------------------------------------------------------------------------------//
////////////////////////////////////////////////////input from for home screen////////////////////////////////////////////////   
void key_scan(){
  char key_1 = myKeypad.getKey(); 
  if (key_1=='1'){
   calibr_fun();
  }
   else if (key_1=='2'){
   sen_fun();
  }
   else if(key_1=='3'){
    manual_out();
   }
  
}
//--------------------------------------------------------------------------------------------------------------------------//
////////////////////////////////////////////////////home screen/////////////////////////////////////////////////////////////////
void home_scr(){
lcd.setCursor(0,0);
lcd.print("1.cali_mod");
lcd.setCursor(0 ,1);
lcd.print("2.sen_mod");
lcd.setCursor(11,0);
lcd.print("3.out_mod");

  
}

void setup(){
  lcd.begin(16,2);
  pinMode(red_out,OUTPUT);
  pinMode(green_out,OUTPUT);
  pinMode(blue_out,OUTPUT);
  pinMode(red_sen,OUTPUT);
  pinMode(green_sen,OUTPUT);
  pinMode(blue_sen,OUTPUT);
  pinMode(ldr_sen,INPUT);
  lcd.setCursor(0,0);
  lcd.print("*---welcome---*");
  delay(1000);

  //added 2nd time
   //defining pins
  pinMode(A1,OUTPUT);
  pinMode(A2,OUTPUT);
  pinMode(A3,OUTPUT);
 digitalWrite(red_out,LOW);
digitalWrite(green_out,LOW);
digitalWrite(blue_out,LOW);
 home_scr();
  
}

void loop(){
  
  key_scan();
}
